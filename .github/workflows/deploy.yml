name: Build and Deploy NotionNext

on:
  push:
    branches:
      - blog.xueayi.site  # ç›‘å¬ä½ çš„åˆ†æ”¯

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. å‡†å¤‡ Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn'

      # 3. å®‰è£…ä¾èµ– (åœ¨ GitHub çš„è™šæ‹Ÿæœºä¸Šè·‘ï¼Œä¸è€—ä½ æœåŠ¡å™¨èµ„æº)
      - name: Install Dependencies
        run: yarn install

      # 4. ç¼–è¯‘ (è¿™æ˜¯æœ€è€—å†…å­˜çš„ä¸€æ­¥)
      - name: Build Project
        env:
          # å¦‚æœä½ çš„ NotionNext ç‰ˆæœ¬åœ¨ç¼–è¯‘æ—¶éœ€è¦è·å–æ•°æ®ï¼Œå¿…é¡»åŠ ä¸Šè¿™ä¸ª ID
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }} 
          NEXT_PUBLIC_THEME: 'hexo' # è¿™é‡Œæ ¹æ®ä½ çš„ hexo ä¸»é¢˜é…ç½®ï¼Œæˆ–è€…åœ¨ actions é‡Œä¸å†™ï¼Œè¯»ä½ ä»£ç é‡Œçš„é…ç½®
        run: |
          # å¤‡ä»½åŸå§‹ package.json
          cp package.json package.json.original
          
          yarn build
          
          # æ„å»ºåå¼ºåˆ¶æ¢å¤åŸå§‹ package.jsonï¼ˆNext.js å¯èƒ½ä¼šä¿®æ”¹å®ƒï¼‰
          cp package.json.original package.json
          rm package.json.original
          
          # åˆ é™¤ .next ç›®å½•å†…å¯èƒ½å­˜åœ¨çš„ package.jsonï¼ˆé˜²æ­¢ rsync è¦†ç›–ï¼‰
          find .next -name "package.json" -delete 2>/dev/null || true
          
          echo "âœ… Verifying root package.json content:"
          head -n 20 package.json
          echo ""
          echo "âœ… Checking package.json has 'scripts' field:"
          grep -q '"scripts"' package.json && echo "OK: scripts field found" || echo "ERROR: scripts field missing!"

      # 5. å‡†å¤‡åŒæ­¥ç›®å½• (å°†æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œé¿å…è·¯å¾„æ··ä¹±)
      - name: Prepare Deploy Directory
        run: |
          mkdir -p deploy_temp
          
          # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          cp -r .next deploy_temp/
          cp -r public deploy_temp/
          cp -r lib deploy_temp/
          cp -r themes deploy_temp/
          cp -r conf deploy_temp/           # blog.config.js ä¾èµ–æ­¤ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶
          cp package.json deploy_temp/
          cp yarn.lock deploy_temp/
          cp next.config.js deploy_temp/
          cp blog.config.js deploy_temp/
          
          # æœ€ç»ˆéªŒè¯éƒ¨ç½²ç›®å½•ç»“æ„
          echo "âœ… Final package.json in deploy_temp:"
          head -n 5 deploy_temp/package.json
          echo ""
          echo "âœ… Checking conf/ directory:"
          ls -la deploy_temp/conf/

      # 6. å°†ç¼–è¯‘äº§ç‰©åŒæ­¥åˆ°æœåŠ¡å™¨
      - name: Deploy to Server via Rsync
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvO --delete"
          SOURCE: "deploy_temp/"
          REMOTE_HOST: ${{ secrets.SERVER_IP }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          TARGET: "/home/xueayi/NotionNext/"
          EXCLUDE: "/node_modules/"

      # 7. åœ¨æœåŠ¡å™¨ä¸Šé‡å¯æœåŠ¡
      - name: Restart Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/xueayi/NotionNext
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # åŠ è½½ nvm
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # åŠ è½½ nvm bash_completion

            # ç¡®è®¤ä¸€ä¸‹ç¯å¢ƒæ˜¯å¦åŠ è½½æˆåŠŸ (è°ƒè¯•ç”¨)
            echo "Current Node version:"
            node -v
            echo "Current Yarn version:"
            yarn -v
            
            # éªŒè¯ package.json æ˜¯å¦å®Œæ•´
            echo "âœ… Verifying package.json on server:"
            head -n 10 package.json
            if grep -q '"scripts"' package.json; then
              echo "âœ… package.json is complete!"
            else
              echo "âŒ ERROR: package.json is incomplete! Aborting deployment."
              exit 1
            fi
            
            # 1. å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ– (æœåŠ¡å™¨åªéœ€è¿è¡Œï¼Œä¸éœ€è¦ devDependenciesï¼Œè¿™æ­¥å¾ˆå¿«ä¸”çœå†…å­˜)
            yarn install --production

            # 2. åœæ­¢æ—§è¿›ç¨‹ (é˜²æ­¢ç«¯å£å†²çªï¼ŒåŒæ—¶å¤„ç† IPv4 å’Œ IPv6)
            echo "Stopping old process..."
            # ä½¿ç”¨ fuser æ€æ‰æ‰€æœ‰å ç”¨ 3000 ç«¯å£çš„è¿›ç¨‹ï¼ˆåŒ…æ‹¬ IPv6ï¼‰
            fuser -k 3000/tcp 2>/dev/null || true
            sleep 2
            # å¦‚æœ fuser ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if command -v fuser > /dev/null 2>&1; then
              fuser -k 3000/tcp 2>/dev/null || true
            else
              # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ ss + kill
              ss -tlnp 'sport = :3000' | grep -oP 'pid=\K\d+' | xargs -r kill -9 2>/dev/null || true
            fi

            # 3. å¯åŠ¨æ–°è¿›ç¨‹
            echo "Starting new process..."
            nohup yarn start >/dev/null 2>&1 &
            
            # ç­‰å¾…å‡ ç§’ç¡®è®¤è¿›ç¨‹å¯åŠ¨
            sleep 3
            if lsof -i:3000 > /dev/null 2>&1; then
              echo "âœ… Server started successfully on port 3000!"
            else
              echo "âš ï¸ Warning: Server may not have started. Check logs."
            fi
            
            echo "ğŸ‰ Deployment finished!"